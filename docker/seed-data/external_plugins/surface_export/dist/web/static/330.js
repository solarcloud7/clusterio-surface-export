"use strict";(self.webpackChunk_solarcloud7_plugin_surface_export=self.webpackChunk_solarcloud7_plugin_surface_export||[]).push([[330],{731(e,t,a){a.d(t,{A:()=>l});var s=a(601),r=a.n(s),n=a(314),i=a.n(n)()(r());i.push([e.id,`.surface-export-tab-body {
	display: grid;
	grid-template-columns: 1fr;
	gap: 16px;
}

@media (min-width: 1200px) {
	.surface-export-tab-body {
		grid-template-columns: 1.2fr 0.8fr;
		align-items: start;
	}
}

.surface-export-tree-panel,
.surface-export-action-panel {
	min-width: 0;
}

.surface-export-log-body {
	display: grid;
	grid-template-columns: 1fr;
	gap: 16px;
}

.surface-export-log-row {
	cursor: pointer;
}

.surface-export-log-row-selected > td {
	background: rgba(24, 144, 255, 0.12) !important;
}
`,""]);let l=i},382(e,t,a){a.r(t),a.d(t,{WebPlugin:()=>WebPlugin});var s=a(848),r=a(860),n=a(968),i=a(168),l=a(68),o=a(696),c=a(72),d=a.n(c),u=a(825),m=a.n(u),p=a(659),f=a.n(p),h=a(56),g=a.n(h),y=a(540),x=a.n(y),I=a(113),v=a.n(I),b=a(731),T={};T.styleTagTransform=v(),T.setAttributes=g(),T.insert=f().bind(null,"head"),T.domAPI=m(),T.insertStyleElement=x(),d()(b.A,T),b.A&&b.A.locals&&b.A.locals;let{PERMISSIONS:S,GetPlatformTreeRequest:k,ListTransactionLogsRequest:w,GetTransactionLogRequest:N,StartPlatformTransferRequest:M,SetSurfaceExportSubscriptionRequest:j,SurfaceExportTreeUpdateEvent:C,SurfaceExportTransferUpdateEvent:E,SurfaceExportLogUpdateEvent:A}=o,{Text:$}=n.Typography;function R(e){switch(e){case"transporting":return"processing";case"awaiting_validation":return"gold";case"completed":return"success";case"failed":case"error":case"cleanup_failed":return"error";default:return"default"}}function P(e,t=null){return e?{transferId:e.transferId||e.id||null,platformName:e.platformName||"Unknown",sourceInstanceId:e.sourceInstanceId??-1,sourceInstanceName:e.sourceInstanceName??null,targetInstanceId:e.targetInstanceId??-1,targetInstanceName:e.targetInstanceName??null,status:e.status||"unknown",startedAt:e.startedAt||Date.now(),completedAt:e.completedAt||null,failedAt:e.failedAt||null,error:e.error||null,lastEventAt:t}:null}function L(e,t){let a=new Map((e||[]).map(e=>[e.transferId,e]));return t&&t.transferId&&a.set(t.transferId,{...a.get(t.transferId),...t}),Array.from(a.values()).sort((e,t)=>(t.startedAt||0)-(e.startedAt||0))}function F({plugin:e,state:t}){let[a,i]=(0,r.useState)(null),[l,o]=(0,r.useState)(null),[c,d]=(0,r.useState)(!1),{tree:u,loadingTree:m,treeError:p}=t,f=(0,r.useMemo)(()=>{let e=new Map;for(let a of t.transferSummaries||[])a?.status==="completed"&&a?.platformName&&!e.has(a.platformName)&&e.set(a.platformName,a);return e},[t.transferSummaries]),h=(0,r.useMemo)(()=>{let e=new Map;if(!u)return e;let t=t=>{for(let a of t.platforms||[]){let s=`platform:${t.instanceId}:${a.platformIndex}`;e.set(s,{instanceId:t.instanceId,instanceName:t.instanceName,forceName:a.forceName||u.forceName||"player",...a})}};for(let e of u.hosts||[])for(let a of e.instances||[])t(a);for(let e of u.unassignedInstances||[])t(e);return e},[u]),g=(0,r.useMemo)(()=>{if(!u)return[];let e=[];for(let t of u.hosts||[])for(let a of[...t.instances||[]].sort((e,t)=>e.instanceName.localeCompare(t.instanceName)))for(let s of a.platforms||[])e.push({key:`platform:${a.instanceId}:${s.platformIndex}`,hostName:t.hostName,hostConnected:t.connected,instanceId:a.instanceId,instanceName:a.instanceName,instanceConnected:a.connected,instancePlatformError:a.platformError,platform:s});if(u.unassignedInstances?.length)for(let t of[...u.unassignedInstances].sort((e,t)=>e.instanceName.localeCompare(t.instanceName)))for(let a of t.platforms||[])e.push({key:`platform:${t.instanceId}:${a.platformIndex}`,hostName:"Unassigned",hostConnected:null,instanceId:t.instanceId,instanceName:t.instanceName,instanceConnected:t.connected,instancePlatformError:t.platformError,platform:a});if(f.size){let t=new Map;for(let[a,s]of f.entries())e.some(e=>e.platform?.platformName===a&&e.instanceId===s.targetInstanceId)&&t.set(a,s.targetInstanceId);return e.filter(e=>{let a=e.platform?.platformName,s=t.get(a);return!s||e.instanceId===s})}return e},[u,f]),y=a?h.get(a):null,x=(0,r.useMemo)(()=>{if(!u)return[];let e=[];for(let t of u.hosts||[])for(let a of t.instances||[])e.push(a);for(let t of u.unassignedInstances||[])e.push(t);return e.filter(e=>e.instanceId!==y?.instanceId).map(e=>({label:`${e.instanceName} (${e.instanceId})`,value:e.instanceId}))},[u,y]);async function I(){if(y&&null!==l){d(!0);try{let t=await e.startTransfer({sourceInstanceId:y.instanceId,sourcePlatformIndex:y.platformIndex,targetInstanceId:Number(l),forceName:y.forceName||"player"});if(!t.success){let e=`Error: ${t.error||"Unknown error"} | Source: Instance ${y.instanceId} (${y.instanceName}) | Platform: ${y.platformName} (index ${y.platformIndex}) | Target: Instance ${l}`;throw console.error("[Surface Export] Transfer failed:",e),Error(t.error||"Transfer start failed")}console.info(`[Surface Export] Transfer started: ${t.transferId}`),n.message.success(`Transfer started: ${t.transferId}`,5)}catch(e){console.error("[Surface Export] Transfer submission error:",e),n.message.error(e.message||"Failed to start transfer",10)}finally{d(!1)}}}let v=[{title:"Host",dataIndex:"hostName",key:"hostName",width:"15%",render:(e,t)=>(0,s.jsxs)(n.Space,{children:[(0,s.jsx)($,{children:e}),null!==t.hostConnected?(0,s.jsx)(n.Tag,{color:t.hostConnected?"green":"default",children:t.hostConnected?"online":"offline"}):null]})},{title:"Instance",dataIndex:"instanceName",key:"instanceName",width:"25%",render:(e,t)=>(0,s.jsxs)(n.Space,{children:[(0,s.jsx)($,{children:e}),(0,s.jsx)(n.Tag,{color:t.instanceConnected?"green":"default",children:t.instanceConnected?"connected":"disconnected"}),t.instancePlatformError?(0,s.jsx)(n.Tag,{color:"warning",children:"error"}):null]})},{title:"Platform",key:"platform",width:"40%",render:(e,t)=>(0,s.jsxs)(n.Space,{children:[(0,s.jsx)($,{children:t.platform.platformName}),(0,s.jsx)(n.Tag,{color:R(t.platform.transferStatus),children:t.platform.transferStatus||"idle"}),!1===t.platform.hasSpaceHub?(0,s.jsx)(n.Tag,{color:"warning",children:"no hub"}):null]})}],b=Number(validation?.entityCount??entityRows.reduce((e,t)=>e+(Number(t.count)||0),0)),T=entityRows.reduce((e,t)=>e+(Number(t.count)||0),0);return(0,r.useMemo)(()=>validation?[{key:"validation:entities",category:"Entities",expected:b,actual:T,delta:T-b,preservedPct:b>0?T/b*100:null,status:1e-4>=Math.abs(T-b)?"Match":"Mismatch",detailCount:entityRows.length},{key:"validation:items",category:"Items",expected:itemExpectedTotal,actual:itemActualTotal,delta:itemActualTotal-itemExpectedTotal,preservedPct:itemExpectedTotal>0?itemActualTotal/itemExpectedTotal*100:null,status:validation.itemCountMatch?"Match":"Mismatch",detailCount:itemRows.length},{key:"validation:fluids",category:"Fluids",expected:fluidExpectedTotal,actual:fluidActualTotal,delta:fluidActualTotal-fluidExpectedTotal,preservedPct:fluidExpectedTotal>0?fluidActualTotal/fluidExpectedTotal*100:null,status:validation.fluidCountMatch?"Match":"Mismatch",detailCount:fluidInventoryRows.length}]:[],[validation,b,T,entityRows,itemExpectedTotal,itemActualTotal,itemRows,fluidExpectedTotal,fluidActualTotal,fluidInventoryRows]),(0,s.jsxs)("div",{className:"surface-export-tab-body",children:[(0,s.jsx)("div",{className:"surface-export-tree-panel",children:(0,s.jsxs)(n.Card,{title:"Available Platforms",children:[m?(0,s.jsx)(n.Spin,{}):null,p?(0,s.jsx)(n.Alert,{type:"error",showIcon:!0,message:p}):null,m||g.length?null:(0,s.jsx)(n.Empty,{description:"No platforms found"}),g.length?(0,s.jsx)(n.Table,{size:"small",columns:v,dataSource:g,rowKey:e=>e.key,pagination:{pageSize:15},rowClassName:e=>e.key===a?"surface-export-log-row-selected":"surface-export-log-row",onRow:e=>({onClick:()=>{e.platform?.hasSpaceHub===!1?n.message.warning("This platform does not have a space hub yet."):i(e.key)}})}):null]})}),(0,s.jsx)("div",{className:"surface-export-action-panel",children:(0,s.jsx)(n.Card,{title:"Manual Transfer",children:(0,s.jsxs)(n.Space,{direction:"vertical",size:"middle",style:{width:"100%"},children:[y?(0,s.jsx)(n.Alert,{type:"info",showIcon:!0,message:`Source: ${y.platformName}`,description:`Instance ${y.instanceName} (${y.instanceId})`}):(0,s.jsx)(n.Alert,{type:"warning",showIcon:!0,message:"Select a source platform in the tree"}),(0,s.jsx)(n.Select,{placeholder:"Select destination instance",options:x,value:l,onChange:o,disabled:!y}),(0,s.jsx)(n.Button,{type:"primary",onClick:I,disabled:!y||null===l,loading:c,children:"Start Transfer"})]})})})]})}function D(e){return String(e||"").replace(/_/g," ").replace(/([a-z])([A-Z])/g,"$1 $2").replace(/\s+/g," ").trim().replace(/^./,e=>e.toUpperCase())}function _(e,t=1){return"number"!=typeof e||Number.isNaN(e)?"-":e.toLocaleString(void 0,{maximumFractionDigits:t})}function z(e,t=1){if("number"!=typeof e||Number.isNaN(e))return"-";let a=e>0?"+":"";return`${a}${e.toLocaleString(void 0,{maximumFractionDigits:t})}`}function H(e){return Object.values(e||{}).reduce((e,t)=>{let a=Number(t);return Number.isFinite(a)?e+a:e},0)}function U(e){return e&&"object"==typeof e?Object.entries(e).map(([e,t])=>{let a="-";if("boolean"==typeof t)a=t?"Yes":"No";else if("number"==typeof t){let s=e.toLowerCase();a=s.endsWith("ms")?`${_(t,0)} ms`:s.endsWith("ticks")?`${_(t,0)} ticks`:s.endsWith("kb")?`${_(t,1)} KB`:_(t,+!Number.isInteger(t))}else null!=t&&(a=String(t));return{key:e,metric:D(e),value:a}}):[]}function K(e,t){for(let a=e.length-1;a>=0;a-=1)if(t(e[a]))return e[a];return null}function V({plugin:e,state:t}){let[a,l]=(0,r.useState)(null),o=a?t.logDetails[a]:null,c=(0,r.useMemo)(()=>{var e;let t,s,r,n,i,l,c,d,u,m,p,f,h,g,y,x,I;return o?(t=o?.transferInfo||null,s=Array.isArray(o?.events)?o.events:[],r=o?.summary&&"object"==typeof o.summary?o.summary:{},n=K(s,e=>e?.eventType==="transfer_created"),i=K(s,e=>e?.eventType==="validation_received"||e?.eventType==="validation_failed"||e?.validation),l=K(s,e=>e?.eventType==="transfer_completed"||e?.eventType==="transfer_failed"),c=s.length?s[s.length-1]:null,d=t?.status||r.status||"unknown",(u=r.result)||(u="completed"===d?"SUCCESS":["failed","error","cleanup_failed"].includes(d)?"FAILED":"IN_PROGRESS"),m=t?.startedAt||r.startedAt||n?.timestampMs||null,p=t?.completedAt||r.completedAt||null,f=t?.failedAt||r.failedAt||null,h=r.lastEventAt||c?.timestampMs||null,g=p||f||l?.timestampMs||h,null===(y="number"==typeof r.totalDurationMs?r.totalDurationMs:null)&&m&&g&&(y=Math.max(0,g-m)),null===y&&"number"==typeof l?.durationMs&&(y=l.durationMs),x=r.validation||i?.validation||null,(I=r.sourceVerification||n?.sourceVerification||null)||!x||(I={itemCounts:x.expectedItemCounts||{},fluidCounts:x.expectedFluidCounts||{}}),{transferId:a,result:u,status:d,totalDurationMs:y,totalDurationStr:r.totalDurationStr||("number"!=typeof(e=y)||Number.isNaN(e)?"-":e>=1e3?`${(e/1e3).toFixed(1)}s (${Math.round(e).toLocaleString()}ms)`:`${Math.round(e).toLocaleString()}ms`),phases:r.phases||l?.phases||{},platform:r.platform||{name:t?.platformName||"Unknown",source:{instanceId:t?.sourceInstanceId??-1,instanceName:t?.sourceInstanceName??null},destination:{instanceId:t?.targetInstanceId??-1,instanceName:t?.targetInstanceName??null}},export:r.export||n?.exportMetrics||null,payload:r.payload||l?.payloadMetrics||n?.payloadMetrics||null,import:r.import||l?.importMetrics||i?.importMetrics||null,validation:x,sourceVerification:I,startedAt:m,completedAt:p,failedAt:f,lastEventAt:h,error:r.error||t?.error||null}):null},[o,a]),d=[{title:"Transfer",dataIndex:"transferId",key:"transferId",render:e=>(0,s.jsx)($,{code:!0,children:e})},{title:"Platform",dataIndex:"platformName",key:"platformName"},{title:"Source",key:"source",render:(e,t)=>t.sourceInstanceName||t.sourceInstanceId},{title:"Destination",key:"destination",render:(e,t)=>t.targetInstanceName||t.targetInstanceId},{title:"Status",dataIndex:"status",key:"status",render:e=>(0,s.jsx)(n.Tag,{color:R(e),children:e})},{title:"Started",dataIndex:"startedAt",key:"startedAt",render:e=>e?new Date(e).toLocaleString():"-"}],u=[{title:"Metric",dataIndex:"metric",key:"metric",width:"60%"},{title:"Value",dataIndex:"value",key:"value"}],m=[{title:"Key",dataIndex:"name",key:"name",width:"40%",render:e=>(0,s.jsx)($,{code:!0,children:e})},{title:"Expected",dataIndex:"expected",key:"expected",render:e=>_(e,+!Number.isInteger(e))},{title:"Actual",dataIndex:"actual",key:"actual",render:e=>_(e,+!Number.isInteger(e))},{title:"Δ",dataIndex:"delta",key:"delta",render:e=>(0,s.jsx)($,{type:0===e?void 0:e>0?"success":"danger",children:z(e,+!Number.isInteger(e))})},{title:"Preserved",dataIndex:"preservedPct",key:"preservedPct",render:e=>null===e?"-":`${_(e,1)}%`}],p=(0,r.useMemo)(()=>(o?.events||[]).map((e,t)=>{let a=[];if("number"==typeof e?.transmissionMs&&a.push({key:"transmission",phase:"Transmission",durationMs:e.transmissionMs,source:"transfer"}),"number"==typeof e?.validationMs&&a.push({key:"validation",phase:"Validation",durationMs:e.validationMs,source:"transfer"}),e?.phases&&"object"==typeof e.phases)for(let[t,s]of Object.entries(e.phases))"number"==typeof s&&a.push({key:`phase:${t}`,phase:D(String(t).replace(/Ms$/,"")),durationMs:s,source:"phase"});if(e?.importMetrics&&"object"==typeof e.importMetrics)for(let[t,s]of[["tiles_ms","Import: Tiles"],["entities_ms","Import: Entities"],["fluids_ms","Import: Fluids"],["belts_ms","Import: Belts"],["state_ms","Import: State Restore"],["validation_ms","Import: Validation"],["total_ms","Import: Total"]]){let r=e.importMetrics?.[t];"number"==typeof r&&a.push({key:`import:${t}`,phase:s,durationMs:r,source:"import"})}let s=[e?.durationMs,e?.validationMs,e?.transmissionMs].find(e=>"number"==typeof e)??null,r=String(e?.eventType||"").includes("failed")||String(e?.eventType||"").includes("error"),n=String(e?.eventType||"").includes("completed")||String(e?.eventType||"").includes("success");return{key:`flow:${e?.timestampMs||Date.now()}:${t}`,eventType:e?.eventType||"event",message:e?.message||"",timestamp:e?.timestamp||null,timestampMs:e?.timestampMs||null,elapsedMs:"number"==typeof e?.elapsedMs?e.elapsedMs:null,deltaMs:"number"==typeof e?.deltaMs?e.deltaMs:null,durationMs:s,phaseTimings:a,exportMetrics:e?.exportMetrics||e?.eventType==="transfer_created"&&c?.export||null,color:r?"red":n?"green":"blue"}}),[o,c]),f=(0,r.useMemo)(()=>U(c?.payload),[c]),h=(0,r.useMemo)(()=>U(c?.export),[c]),g=(0,r.useMemo)(()=>U(c?.import),[c]),y=c?.validation||null,x=(0,r.useMemo)(()=>y?[{key:"itemCountMatch",metric:"Item counts match",value:y.itemCountMatch?"Yes":"No"},{key:"fluidCountMatch",metric:"Fluid counts match",value:y.fluidCountMatch?"Yes":"No"},{key:"entityCount",metric:"Entity count",value:_(y.entityCount,0)},{key:"itemTypesExpected",metric:"Item types (expected)",value:_(y.itemTypesExpected,0)},{key:"itemTypesActual",metric:"Item types (actual)",value:_(y.itemTypesActual,0)},{key:"fluidTypesExpected",metric:"Fluid types (expected)",value:_(y.fluidTypesExpected,0)},{key:"fluidTypesActual",metric:"Fluid types (actual)",value:_(y.fluidTypesActual,0)}]:[],[y]),I=y?.expectedItemCounts||c?.sourceVerification?.itemCounts||{},v=y?.actualItemCounts||{},b=y?.expectedFluidCounts||c?.sourceVerification?.fluidCounts||{},T=y?.actualFluidCounts||{},S=(0,r.useMemo)(()=>(function(e,t){let a=e||{},s=t||{},r=new Set([...Object.keys(a),...Object.keys(s)]),n=[];for(let e of r){let t=Number(a[e]||0),r=Number(s[e]||0),i=r-t;n.push({key:e,name:e,expected:t,actual:r,delta:i,preservedPct:t>0?r/t*100:null})}return n.sort((e,t)=>Math.abs(t.delta)-Math.abs(e.delta)||e.name.localeCompare(t.name)),n})(I,v),[I,v]),k=Number(y?.fluidReconciliation?.highTempThreshold??1e4),w=(0,r.useMemo)(()=>(function(e,t,a=1e4,s={}){let r=e||{},n=t||{},i=s||{},l=Number.isFinite(Number(a))?Number(a):1e4,o=new Set([...Object.keys(r),...Object.keys(n)]),c=new Map;for(let e of o){let t=Number(r[e]||0),a=Number(n[e]||0),s=a-t,i=function(e){let t=String(e||""),a=t.match(/^(.*)@(-?\d+(?:\.\d+)?)C$/i);return a?{baseName:a[1]||t,temperatureC:Number(a[2]),rawKey:t}:{baseName:t,temperatureC:null,rawKey:t}}(e),o=null!==i.temperatureC&&i.temperatureC>=l,d=i.baseName||e;c.has(d)||c.set(d,{baseName:d,expected:0,actual:0,hasHighTempBucket:!1,children:[]});let u=c.get(d);u.expected+=t,u.actual+=a,u.hasHighTempBucket=u.hasHighTempBucket||o,u.children.push({key:`fluid:bucket:${e}`,name:d,bucketKey:e,tempBucket:null===i.temperatureC?"-":`${_(i.temperatureC,1)}\xb0C`,category:o?"High-temp":"Normal",expected:t,actual:a,delta:s,preservedPct:t>0?a/t*100:null,isGroup:!1,status:"Match",reconciled:!1})}let d=[];for(let e of c.values()){let t=e.actual-e.expected,a=e.hasHighTempBucket?"High-temp":"Normal",s=i[e.baseName],r="High-temp"===a&&!!(s?.reconciled??1>=Math.abs(t)),n=e.children.map(e=>{let t=Math.abs(e.delta),a="Match";return"High-temp"===e.category&&r?a=t>1e-4?"Bucket drift (reconciled)":"Match":t>1e-4&&(a="Mismatch"),{...e,status:a,reconciled:"High-temp"===e.category?r:t<=1e-4}}).sort((e,t)=>Math.abs(t.delta)-Math.abs(e.delta)||e.bucketKey.localeCompare(t.bucketKey));d.push({key:`fluid:group:${e.baseName}`,name:e.baseName,category:a,expected:e.expected,actual:e.actual,delta:t,preservedPct:e.expected>0?e.actual/e.expected*100:null,isGroup:!0,status:"High-temp"===a&&r?"Reconciled aggregate":1e-4>=Math.abs(t)?"Match":"Mismatch",reconciled:"High-temp"===a?r:1e-4>=Math.abs(t),children:n})}return d.sort((e,t)=>Math.abs(t.delta)-Math.abs(e.delta)||e.name.localeCompare(t.name)),d})(b,T,k,y?.fluidReconciliation?.highTempAggregates||{}),[b,T,k,y]);y?.totalExpectedItems??H(I),y?.totalActualItems??H(v),y?.totalExpectedFluids??H(b),y?.totalActualFluids??H(T);let N=(0,r.useMemo)(()=>Object.entries(y?.entityTypeBreakdown||{}).map(([e,t])=>({key:e,entityType:e,count:Number(t)||0})).sort((e,t)=>t.count-e.count),[y]),M=(0,r.useMemo)(()=>{let e=y?.fluidReconciliation;return e?[{key:"rawFluidDelta",metric:"Raw fluid delta",value:z(e.rawFluidDelta,1)},{key:"reconciledFluidLoss",metric:"Reconciled fluid loss",value:_(e.reconciledFluidLoss,1)},{key:"lowTempLoss",metric:"Low-temp loss",value:_(e.lowTempLoss,1)},{key:"highTempReconciledLoss",metric:"High-temp reconciled loss",value:_(e.highTempReconciledLoss,1)},{key:"fluidPreservedPct",metric:"Fluid preserved",value:`${_(e.fluidPreservedPct,1)}%`},{key:"highTempThreshold",metric:"High-temp threshold",value:_(e.highTempThreshold,0)}]:[]},[y]),j=[{title:"Fluid / Bucket",key:"fluid",width:"32%",render:(e,t)=>t.isGroup?(0,s.jsx)($,{code:!0,children:t.name}):(0,s.jsx)(n.Tooltip,{title:t.bucketKey,children:(0,s.jsx)($,{type:"secondary",children:"-"===t.tempBucket?t.bucketKey:`@${t.tempBucket}`})})},{title:"Category",dataIndex:"category",key:"category",render:e=>(0,s.jsx)(n.Tag,{color:"High-temp"===e?"gold":"default",children:e})},{title:"Expected",dataIndex:"expected",key:"expected",render:e=>_(e,1)},{title:"Actual",dataIndex:"actual",key:"actual",render:e=>_(e,1)},{title:"Δ",dataIndex:"delta",key:"delta",render:(e,t)=>!t.isGroup&&"High-temp"===t.category&&t.reconciled&&Math.abs(e)>1e-4?(0,s.jsx)($,{type:"warning",children:z(e,1)}):(0,s.jsx)($,{type:0===e?void 0:e>0?"success":"danger",children:z(e,1)})},{title:"Preserved",dataIndex:"preservedPct",key:"preservedPct",render:e=>null===e?"-":`${_(e,1)}%`},{title:"Status",dataIndex:"status",key:"status",render:(e,t)=>"Reconciled aggregate"===e?(0,s.jsx)(n.Tag,{color:"green",children:"Reconciled aggregate"}):"Bucket drift (reconciled)"===e?(0,s.jsx)(n.Tooltip,{title:"High-temp bucket drift is expected from temperature merging/averaging.",children:(0,s.jsx)(n.Tag,{color:"gold",children:"Bucket drift (reconciled)"})}):"Mismatch"===e?(0,s.jsx)(n.Tag,{color:"High-temp"===t.category?"warning":"error",children:"Mismatch"}):(0,s.jsx)(n.Tag,{color:"default",children:"Match"})}],C=c?.status||o?.transferInfo?.status||"unknown",E=c?.result||"IN_PROGRESS",A=!!(o&&c),P=!!y;return(0,s.jsxs)("div",{className:"surface-export-log-body",children:[(0,s.jsx)(n.Card,{title:"Recent Transfer Logs",children:(0,s.jsx)(n.Table,{size:"small",columns:d,dataSource:t.transferSummaries,rowKey:e=>e.transferId,pagination:{pageSize:10},rowClassName:e=>e.transferId===a?"surface-export-log-row-selected":"surface-export-log-row",onRow:t=>({onClick:async()=>{l(t.transferId);try{await e.loadTransactionLog(t.transferId)}catch(e){n.message.error(e.message||"Failed to load transaction log")}}})})}),a?null:(0,s.jsx)(n.Card,{title:"Transfer Details",children:(0,s.jsx)(n.Empty,{description:"Select a transfer row to view details"})}),a&&!o?(0,s.jsx)(n.Card,{title:"Transfer Details",children:(0,s.jsx)(n.Spin,{})}):null,A?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.Card,{title:"Transfer Summary",children:[(0,s.jsx)(n.Alert,{type:"SUCCESS"===E?"success":"FAILED"===E?"error":"info",showIcon:!0,message:`${E}: ${c.platform?.name||a}`,description:`Duration: ${c.totalDurationStr} | Status: ${C}`}),(0,s.jsxs)(n.Space,{direction:"vertical",style:{width:"100%",marginTop:12},children:[c.error?(0,s.jsx)(n.Alert,{type:"error",showIcon:!0,message:"Transfer error",description:c.error}):null,(0,s.jsx)(n.Table,{size:"small",pagination:!1,columns:u,dataSource:[{key:"platform",metric:"Platform",value:c.platform?.name||"-"},{key:"source",metric:"Source",value:c.platform?.source?.instanceName||c.platform?.source?.instanceId||"-"},{key:"destination",metric:"Destination",value:c.platform?.destination?.instanceName||c.platform?.destination?.instanceId||"-"}]})]})]}),(0,s.jsx)(n.Card,{title:"Payload Metrics",children:f.length?(0,s.jsx)(n.Table,{size:"small",pagination:!1,columns:u,dataSource:f}):(0,s.jsx)(n.Empty,{description:"No payload metrics available"})}),(0,s.jsx)(n.Card,{title:"Export Metrics",children:h.length?(0,s.jsx)(n.Table,{size:"small",pagination:!1,columns:u,dataSource:h}):(0,s.jsx)(n.Empty,{description:"No export timing metrics available"})}),(0,s.jsx)(n.Card,{title:"Import Processing Metrics",children:g.length?(0,s.jsx)(n.Table,{size:"small",pagination:!1,columns:u,dataSource:g}):(0,s.jsx)(n.Empty,{description:"No import metrics available"})}),(0,s.jsx)(n.Card,{title:"Validation Overview",children:P?(0,s.jsxs)(n.Space,{direction:"vertical",style:{width:"100%"},children:[(0,s.jsx)(n.Table,{size:"small",pagination:!1,columns:u,dataSource:x}),y?.mismatchDetails?(0,s.jsx)(n.Alert,{type:"error",showIcon:!0,message:"Validation mismatch details",description:y.mismatchDetails}):null,(0,s.jsx)(n.Table,{size:"small",pagination:!1,columns:validationCategoryColumns,dataSource:validationCategoryRows,expandable:{expandedRowRender:e=>"validation:entities"===e.key?N.length?(0,s.jsx)(n.Table,{size:"small",pagination:{pageSize:10},columns:[{title:"Entity Type",dataIndex:"entityType",key:"entityType",render:e=>(0,s.jsx)($,{code:!0,children:e})},{title:"Count",dataIndex:"count",key:"count",render:e=>_(e,0)}],dataSource:N,rowKey:e=>e.key}):(0,s.jsx)(n.Empty,{description:"No entity details available"}):"validation:items"===e.key?S.length?(0,s.jsx)(n.Table,{size:"small",pagination:{pageSize:10},columns:m,dataSource:S,rowKey:e=>e.key}):(0,s.jsx)(n.Empty,{description:"No item details available"}):"validation:fluids"===e.key?(0,s.jsxs)(n.Space,{direction:"vertical",style:{width:"100%"},size:"middle",children:[w.length?(0,s.jsx)(n.Table,{size:"small",pagination:{pageSize:10},columns:j,dataSource:w,rowKey:e=>e.key}):(0,s.jsx)(n.Empty,{description:"No fluid details available"}),M.length?(0,s.jsx)(n.Table,{size:"small",pagination:!1,columns:u,dataSource:M,rowKey:e=>e.key}):null]}):null,rowExpandable:e=>["validation:entities","validation:items","validation:fluids"].includes(e.key)},rowKey:e=>e.key})]}):(0,s.jsx)(n.Empty,{description:"No validation data available yet"})}),(0,s.jsx)(n.Card,{title:(0,s.jsxs)(n.Space,{size:"small",children:[(0,s.jsx)("span",{children:"Transfer Flow (Timeline + Phases)"}),(0,s.jsx)(n.Tooltip,{title:"Chronological events with phase and import timing details in ms.",children:(0,s.jsx)(i.A,{})})]}),children:p.length?(0,s.jsx)(n.Table,{size:"small",pagination:{pageSize:20},columns:flowColumns,dataSource:p,rowKey:e=>e.key,expandable:{expandedRowRender:e=>(0,s.jsxs)(n.Space,{direction:"vertical",style:{width:"100%"},children:[e.phaseTimings?.length?(0,s.jsx)(n.Table,{size:"small",pagination:!1,columns:[{title:"Phase",dataIndex:"phase",key:"phase"},{title:"Source",dataIndex:"source",key:"source",render:e=>(0,s.jsx)(n.Tag,{children:e})},{title:"Duration",dataIndex:"durationMs",key:"durationMs",render:e=>`${_(e,0)} ms`}],dataSource:e.phaseTimings,rowKey:e=>e.key}):(0,s.jsx)(n.Empty,{description:"No phase timing details on this step"}),e.exportMetrics?(0,s.jsx)(n.Table,{size:"small",pagination:!1,columns:u,dataSource:U(e.exportMetrics),rowKey:e=>e.key}):null]}),rowExpandable:e=>!!(e.phaseTimings?.length||e.exportMetrics)}}):(0,s.jsx)(n.Empty,{description:"No transfer flow events available"})})]}):null]})}function B(){let e=(0,r.useContext)(l.ControlContext).plugins.get("surface_export"),t=function(e){let[t,a]=(0,r.useState)(e.getState());return(0,r.useEffect)(()=>{function t(){a(e.getState())}return e.onUpdate(t),()=>e.offUpdate(t)},[e]),t}(e),a=t?.pluginVersion||null,i=[{key:"manual",label:"Manual Transfer",children:(0,s.jsx)(F,{plugin:e,state:t})}];return!1!==t.canViewLogs&&i.push({key:"logs",label:"Transaction Logs",children:(0,s.jsx)(V,{plugin:e,state:t})}),(0,s.jsxs)(l.PageLayout,{nav:[{name:"Surface Export"}],children:[(0,s.jsx)(l.PageHeader,{title:"Surface Export"}),a?(0,s.jsxs)($,{type:"secondary",style:{fontSize:12,display:"block",marginBottom:12},children:["v",a]}):null,(0,s.jsx)(n.Tabs,{defaultActiveKey:"manual",items:i})]})}let WebPlugin=class WebPlugin extends l.BaseWebPlugin{constructor(e,t,a,s,r){super(e,t,a,s,r),this.callbacks=[],this.liveUpdatesEnabled=!1,this.state={tree:null,loadingTree:!1,treeError:null,transferSummaries:[],logDetails:{},lastTreeRevision:0,lastTransferRevision:0,lastLogRevision:0,canViewLogs:!0,pluginVersion:t?.version||null}}async init(){this.pages=[{path:"/surface-export",sidebarName:"Surface Export",permission:S.UI_VIEW,content:(0,s.jsx)(B,{})}],this.control.handle(C,this.handleTreeUpdate.bind(this)),this.control.handle(E,this.handleTransferUpdate.bind(this)),this.control.handle(A,this.handleLogUpdate.bind(this))}onControllerConnectionEvent(e){("connect"===e||"resume"===e)&&this.syncLiveState().catch((0,l.notifyErrorHandler)("Failed to resubscribe Surface Export live updates"))}getState(){return this.state}setState(e){for(let t of(this.state={...this.state,...e},this.callbacks))t()}onUpdate(e){this.callbacks.push(e),this.syncLiveState().catch((0,l.notifyErrorHandler)("Failed to start Surface Export live updates"))}offUpdate(e){let t=this.callbacks.lastIndexOf(e);-1!==t&&this.callbacks.splice(t,1),this.syncLiveState().catch((0,l.notifyErrorHandler)("Failed to update Surface Export subscription"))}async syncLiveState(){let e=this.callbacks.length>0;if(!this.control.connector.connected){this.liveUpdatesEnabled=e;return}let t=t=>this.control.send(new j({tree:e,transfers:e,logs:t,transferId:null})),a=e&&!1!==this.state.canViewLogs;try{await t(a)}catch(e){if(a&&/permission denied/i.test(e?.message||""))a=!1,this.setState({canViewLogs:!1}),await t(!1);else throw e}this.liveUpdatesEnabled=e,e&&await this.refreshSnapshots()}async refreshSnapshots(){this.setState({loadingTree:!0,treeError:null});try{let e=await this.control.send(new k({forceName:"player"})),t=this.state.transferSummaries;if(!1!==this.state.canViewLogs)try{let e=await this.control.send(new w({limit:100}));t=Array.isArray(e)?[...e].sort((e,t)=>(t.startedAt||0)-(e.startedAt||0)):[]}catch(e){if(/permission denied/i.test(e?.message||""))this.setState({canViewLogs:!1}),t=[];else throw e}this.setState({tree:{forceName:e.forceName,hosts:e.hosts||[],unassignedInstances:e.unassignedInstances||[],revision:e.revision,generatedAt:e.generatedAt},transferSummaries:t,loadingTree:!1,treeError:null})}catch(e){this.setState({loadingTree:!1,treeError:e.message||"Failed to refresh Surface Export state"})}}async startTransfer(e){return this.control.send(new M(e))}async loadTransactionLog(e){let t=await this.control.send(new N({transferId:e}));if(!t.success)throw Error(t.error||"Failed to load transaction log");let a=this.state.logDetails[e]||{},s=t.transferInfo||a.transferInfo||null,r=Array.isArray(t.events)?t.events:a.events||[],n={transferInfo:s,summary:t.summary||a.summary||null,events:r},i=P(s,r.length?r[r.length-1].timestampMs:null);i&&(i.transferId=e),this.setState({logDetails:{...this.state.logDetails,[e]:n},transferSummaries:i?L(this.state.transferSummaries,i):this.state.transferSummaries})}async handleTreeUpdate(e){e.revision<=this.state.lastTreeRevision||this.setState({tree:{forceName:e.forceName,hosts:e.tree?.hosts||[],unassignedInstances:e.tree?.unassignedInstances||[],revision:e.revision,generatedAt:e.generatedAt},loadingTree:!1,treeError:null,lastTreeRevision:e.revision})}async handleTransferUpdate(e){e.revision<=this.state.lastTransferRevision||this.setState({transferSummaries:L(this.state.transferSummaries,e.transfer),lastTransferRevision:e.revision})}async handleLogUpdate(e){if(e.revision<=this.state.lastLogRevision)return;let t=this.state.logDetails[e.transferId]||{events:[]},a=[...t.events],s=e.event||{},r=a.length?a[a.length-1]:null;r&&r.timestampMs===s.timestampMs&&r.eventType===s.eventType&&r.message===s.message||a.push(s);let n={transferInfo:e.transferInfo||t.transferInfo||null,summary:e.summary||t.summary||null,events:a},i=null;e.transferInfo&&((i=P(e.transferInfo,s.timestampMs||null)).transferId=e.transferId),this.setState({logDetails:{...this.state.logDetails,[e.transferId]:n},transferSummaries:i?L(this.state.transferSummaries,i):this.state.transferSummaries,lastLogRevision:e.revision})}}}}]);
//# sourceMappingURL=330.js.map