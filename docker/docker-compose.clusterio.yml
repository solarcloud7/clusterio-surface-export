# Docker Compose for Clusterio Development Cluster
# 
# Architecture:
#   - 1 Controller (manages cluster)
#   - 1 Init service (bootstraps cluster configuration)
#   - 2 Hosts (run Factorio instances)
#   - 2 Instances (assigned to hosts after initialization)
#
# Startup sequence:
#   1. Controller starts
#   2. Init service runs bootstrap script (creates instances, host configs)
#   3. Hosts start and connect to controller
#   4. Manual step: Assign instances to hosts

services:
  # =====================================================
  # Clusterio Controller
  # Central management server for the cluster
  # =====================================================
  clusterio-controller:
    build:
      context: ..
      dockerfile: docker/Dockerfile.controller
    container_name: clusterio-controller
    hostname: clusterio-controller
    environment:
      - CONTROLLER_HTTP_PORT=${CONTROLLER_HTTP_PORT}
      - FACTORIO_USERNAME=${FACTORIO_USERNAME}
      - FACTORIO_TOKEN=${FACTORIO_TOKEN}
    ports:
      - "${CONTROLLER_HTTP_PORT}:${CONTROLLER_HTTP_PORT}"   # HTTP API, Web UI, and WebSocket
    volumes:
      # Controller data (database, config, logs)
      - ./clusterio-containers/controller:/clusterio:rw
      # Development: Mount plugin source code with save-patched module
      - ./seed-data/external_plugins/surface_export:/opt/seed-plugins/surface-export:ro
    networks:
      - clusterio-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://localhost:$$CONTROLLER_HTTP_PORT/ || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 12
      start_period: 10s

  # =====================================================
  # Cluster Initialization Service
  # Runs once to bootstrap cluster configuration
  # =====================================================
  clusterio-init:
    build:
      context: ..
      dockerfile: docker/Dockerfile.controller
    container_name: clusterio-init
    environment:
      - CONTROLLER_HTTP_PORT=${CONTROLLER_HTTP_PORT}
      - HOST1_INSTANCE1_GAME_PORT=${HOST1_INSTANCE1_GAME_PORT}
      - HOST1_INSTANCE1_RCON_PORT=${HOST1_INSTANCE1_RCON_PORT}
      - HOST2_INSTANCE1_GAME_PORT=${HOST2_INSTANCE1_GAME_PORT}
      - HOST2_INSTANCE1_RCON_PORT=${HOST2_INSTANCE1_RCON_PORT}
      - RCON_PASSWORD=${RCON_PASSWORD}
      - MOD_PACK_FACTORIO_VERSION=${MOD_PACK_FACTORIO_VERSION:-2.0}
      - FACTORIO_AUTO_START=${FACTORIO_AUTO_START:-false}
      - SURFACE_EXPORT_MOD_VERSION=${SURFACE_EXPORT_MOD_VERSION:-1.0.37}
      - FACTORIO_ADMINS=${FACTORIO_ADMINS}
      - INSTANCE1_SAVE_NAME=${INSTANCE1_SAVE_NAME}
      - INSTANCE2_SAVE_NAME=${INSTANCE2_SAVE_NAME}
    volumes:
      # Share controller data to create control config
      - ./clusterio-containers/controller:/clusterio:rw
      # Development: Mount plugin source code
      - ./seed-data/external_plugins/surface_export:/opt/seed-plugins/surface-export:ro
      # Mount initialization script
      - ./seed-data/scripts/clusterio-init.sh:/clusterio-init.sh:ro
      # Mount hosts directory to write host configs
      - ./clusterio-containers/hosts:/clusterio-hosts:rw
    networks:
      - clusterio-net
    depends_on:
      clusterio-controller:
        condition: service_healthy
    command: ["/bin/bash", "/clusterio-init.sh"]
    restart: "no"


  # =====================================================
  # Clusterio Host 1
  # Runs Factorio instances assigned to it
  # =====================================================
  clusterio-host-1:
    build:
      context: ..
      dockerfile: docker/Dockerfile.host
    container_name: clusterio-host-1
    hostname: clusterio-host-1
    ports:
      - "${HOST1_INSTANCE1_GAME_PORT}:${HOST1_INSTANCE1_GAME_PORT}/udp"  # Factorio game port (UDP)
      - "${HOST1_INSTANCE1_RCON_PORT}:${HOST1_INSTANCE1_RCON_PORT}/tcp"  # RCON port (TCP)
    volumes:
      # Host data and instance directories
      - ./clusterio-containers/hosts/clusterio-host-1:/clusterio:rw
      # Development: Mount plugin source code
      - ./seed-data/external_plugins/surface_export:/opt/seed-plugins/surface-export:ro
    environment:
      - HOST_NAME=clusterio-host-1
      - FACTORIO_USERNAME=${FACTORIO_USERNAME}
      - FACTORIO_TOKEN=${FACTORIO_TOKEN}
      - FACTORIO_ADMINS=${FACTORIO_ADMINS}
    networks:
      - clusterio-net
    depends_on:
      clusterio-controller:
        condition: service_healthy
    restart: unless-stopped

  # =====================================================
  # Clusterio Host 2
  # Runs Factorio instances assigned to it
  # =====================================================
  clusterio-host-2:
    build:
      context: ..
      dockerfile: docker/Dockerfile.host
    container_name: clusterio-host-2
    hostname: clusterio-host-2
    ports:
      - "${HOST2_INSTANCE1_GAME_PORT}:${HOST2_INSTANCE1_GAME_PORT}/udp"  # Factorio game port (UDP)
      - "${HOST2_INSTANCE1_RCON_PORT}:${HOST2_INSTANCE1_RCON_PORT}/tcp"  # RCON port (TCP)
    volumes:
      # Host data and instance directories
      - ./clusterio-containers/hosts/clusterio-host-2:/clusterio:rw
      # Development: Mount plugin source code
      - ./seed-data/external_plugins/surface_export:/opt/seed-plugins/surface-export:ro
      
    environment:
      - HOST_NAME=clusterio-host-2
      - FACTORIO_USERNAME=${FACTORIO_USERNAME}
      - FACTORIO_TOKEN=${FACTORIO_TOKEN}
      - FACTORIO_ADMINS=${FACTORIO_ADMINS}
    networks:
      - clusterio-net
    depends_on:
      clusterio-controller:
        condition: service_healthy
    restart: unless-stopped

networks:
  clusterio-net:
    driver: bridge

# Note: All data is stored in local directories for persistence and clarity:
#   READ-ONLY INPUTS:  mods/, saves-seed/ (shared templates)
#   READ-WRITE OUTPUTS: 
#     - clusterio-containers/ (hierarchical per-component structure)
#     -- controller/ (controller logs, config, database, plugins)
#     -- hosts/<host-name>/ (all per-host data: clusterio config, factorio configs (generated), logs, saves, script-output, instances)
#   clusterio-containers/
#     ├── controller/          (Controller database, config, logs)
#     ├── host-configs/        (Host configuration files)
#     └── hosts/
#         ├── clusterio-host-1/   (Host 1 data, instance files)
#         └── clusterio-host-2/   (Host 2 data, instance files)
